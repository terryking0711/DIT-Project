
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Arduino é™æ§è»Šæ§åˆ¶å°</title>
<style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
}

.container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    max-width: 500px;
    width: 100%;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

h1 {
    text-align: center;
    color: #333;
    margin-bottom: 30px;
    font-size: 2.2em;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.control-section {
    margin-bottom: 25px;
}

.section-title {
    font-size: 1.1em;
    color: #555;
    margin-bottom: 15px;
    font-weight: 500;
    text-align: center;
}

/* æ–¹å‘æ§åˆ¶å€åŸŸ */
.direction-grid {
    display: grid;
    grid-template-columns: 80px 80px 80px;
    grid-template-rows: 80px 80px 80px;
    gap: 8px;
    justify-content: center;
    margin-bottom: 20px;
}

.direction-grid button:nth-child(1) { grid-column: 2; grid-row: 1; } /* å‰é€² */
.direction-grid button:nth-child(2) { grid-column: 1; grid-row: 2; } /* å·¦è½‰ */
.direction-grid button:nth-child(3) { grid-column: 2; grid-row: 2; } /* åœæ­¢ */
.direction-grid button:nth-child(4) { grid-column: 3; grid-row: 2; } /* å³è½‰ */
.direction-grid button:nth-child(5) { grid-column: 2; grid-row: 3; } /* å¾Œé€€ */

/* æ©Ÿæ¢°æ‰‹è‡‚æ§åˆ¶å€åŸŸ */
.arm-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
}

/* ç‰¹æ®ŠåŠŸèƒ½å€åŸŸ */
.function-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

button {
    font-size: 16px;
    font-weight: 600;
    padding: 12px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

button:hover::before {
    left: 100%;
}

/* æ–¹å‘æŒ‰éµæ¨£å¼ */
.direction-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    font-size: 18px;
}

.direction-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.direction-btn:active {
    transform: translateY(0);
}

/* åœæ­¢æŒ‰éµç‰¹æ®Šæ¨£å¼ */
.stop-btn {
    background: linear-gradient(135deg, #f44336, #d32f2f) !important;
    font-size: 16px;
}

.stop-btn:hover {
    box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4) !important;
}

/* æ©Ÿæ¢°æ‰‹è‡‚æŒ‰éµæ¨£å¼ */
.arm-btn {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

.arm-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
}

/* åŠŸèƒ½æŒ‰éµæ¨£å¼ */
.function-btn {
    background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    color: white;
}

.function-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 480px) {
    .container {
        padding: 20px;
        margin: 10px;
    }
    
    h1 {
        font-size: 1.8em;
    }
    
    .direction-grid {
        grid-template-columns: 70px 70px 70px;
        grid-template-rows: 70px 70px 70px;
    }
    
    button {
        font-size: 14px;
        padding: 10px;
    }
}

/* æ»‘æ¡¿æ§åˆ¶å€åŸŸ */
.slider-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.slider-item {
    background: rgba(0, 0, 0, 0.02);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.slider-label {
    font-size: 14px;
    font-weight: 500;
    color: #555;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.slider-value {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    background: rgba(33, 150, 243, 0.1);
    padding: 2px 8px;
    border-radius: 4px;
    min-width: 40px;
    text-align: center;
}

/* æ»‘æ¡¿æ¨£å¼ */
.slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: #ddd;
    outline: none;
    transition: all 0.3s ease;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2196F3, #1976D2);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
    transition: all 0.3s ease;
}

.slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.6);
}

.slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2196F3, #1976D2);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
    transition: all 0.3s ease;
}

.slider::-moz-range-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.6);
}

.slider:active::-webkit-slider-thumb {
    transform: scale(0.9);
}

.slider:active::-moz-range-thumb {
    transform: scale(0.9);
}

/* é€Ÿåº¦æ»‘æ¡¿ç‰¹æ®Šæ¨£å¼ */
.speed-slider::-webkit-slider-thumb {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
}

.speed-slider::-moz-range-thumb {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
}

/* è½‰å‘æ»‘æ¡¿ç‰¹æ®Šæ¨£å¼ */
.turn-slider::-webkit-slider-thumb {
    background: linear-gradient(135deg, #FF9800, #F57C00);
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4);
}

.turn-slider::-moz-range-thumb {
    background: linear-gradient(135deg, #FF9800, #F57C00);
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4);
}

/* ç‹€æ…‹æŒ‡ç¤º */
.status {
    text-align: center;
    margin-top: 20px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 8px;
    font-size: 14px;
    color: #666;
}
</style>
</head>
<body>
<div class="container">
    <h1>Arduino é™æ§è»Š</h1>
    
    <div class="control-section">
        <div class="section-title">æ–¹å‘æ§åˆ¶</div>
        <div class="direction-grid">
            <button class="direction-btn" onmousedown="send('F',1)" onmouseup="send('F',0)" ontouchstart="send('F',1)" ontouchend="send('F',0)">
                <div>â¬†ï¸</div>
                <div>å‰é€²</div>
            </button>
            <button class="direction-btn" onmousedown="send('L',1)" onmouseup="send('L',0)" ontouchstart="send('L',1)" ontouchend="send('L',0)">
                <div>â¬…ï¸</div>
                <div>å·¦è½‰</div>
            </button>
            <button class="direction-btn stop-btn" onclick="sendAct('S')">
                <div>â¹ï¸</div>
                <div>åœæ­¢</div>
            </button>
            <button class="direction-btn" onmousedown="send('R',1)" onmouseup="send('R',0)" ontouchstart="send('R',1)" ontouchend="send('R',0)">
                <div>â¡ï¸</div>
                <div>å³è½‰</div>
            </button>
            <button class="direction-btn" onmousedown="send('B',1)" onmouseup="send('B',0)" ontouchstart="send('B',1)" ontouchend="send('B',0)">
                <div>â¬‡ï¸</div>
                <div>å¾Œé€€</div>
            </button>
        </div>
    </div>

    <div class="control-section">
        <div class="section-title">æ©Ÿæ¢°æ‰‹è‡‚</div>
        <div class="arm-grid">
            <button class="arm-btn" onclick="sendAct('U')">
                <div>â¬†ï¸</div>
                <div>æ‰‹è‡‚ä¸Šå‡</div>
            </button>
            <button class="arm-btn" onclick="sendAct('D')">
                <div>â¬‡ï¸</div>
                <div>æ‰‹è‡‚ä¸‹é™</div>
            </button>
            <button class="arm-btn" onclick="sendAct('O')">
                <div>âœ‹</div>
                <div>å¼µé–‹</div>
            </button>
            <button class="arm-btn" onclick="sendAct('C')">
                <div>âœŠ</div>
                <div>å¤¾ç·Š</div>
            </button>
        </div>
    </div>

    <div class="control-section">
        <div class="section-title">ğŸšï¸ åƒæ•¸æ§åˆ¶</div>
        <div class="slider-grid">
            <div class="slider-item">
                <div class="slider-label">
                    <span>ç§»å‹•é€Ÿåº¦</span>
                    <span class="slider-value" id="speed-value">50</span>
                </div>
                <input type="range" min="10" max="100" value="50" 
                       class="slider speed-slider" id="speed-slider" 
                       oninput="updateSpeed(this.value)">
            </div>
            
            <div class="slider-item">
                <div class="slider-label">
                    <span>è½‰å‘éˆæ•åº¦</span>
                    <span class="slider-value" id="turn-value">50</span>
                </div>
                <input type="range" min="10" max="100" value="50" 
                       class="slider turn-slider" id="turn-slider" 
                       oninput="updateTurnSensitivity(this.value)">
            </div>
            
            <div class="slider-item">
                <div class="slider-label">
                    <span>æ‰‹è‡‚é€Ÿåº¦</span>
                    <span class="slider-value" id="arm-value">30</span>
                </div>
                <input type="range" min="5" max="80" value="30" 
                       class="slider" id="arm-slider" 
                       oninput="updateArmSpeed(this.value)">
            </div>
        </div>
    </div>

    <div class="control-section">
        <div class="section-title">âš¡ ç‰¹æ®ŠåŠŸèƒ½</div>
        <div class="function-grid">
            <button class="function-btn" onclick="sendAct('X')">
                <div>ğŸ”„</div>
                <div>ç¿»è½‰</div>
            </button>
            <button class="function-btn" onclick="sendAct('H')">
                <div>ğŸ </div>
                <div>å›åˆ°åŸé»</div>
            </button>
        </div>
    </div>

    <div class="status" id="status">
        æº–å‚™å°±ç·’ ğŸŸ¢
    </div>
</div>
<script>
let isConnected = true;
let currentMoving = false;

// æ»‘æ¡¿åƒæ•¸
let speedValue = 50;
let turnSensitivity = 50;
let armSpeed = 30;

async function send(command, state) {
    const statusElement = document.getElementById('status');
    
    try {
        if (state === 1 && !currentMoving) {
            statusElement.innerHTML = `ğŸš— ${getCommandName(command)}ä¸­...`;
            statusElement.style.color = '#2196f3';
            currentMoving = true;
        } else if (state === 0 && currentMoving) {
            statusElement.innerHTML = 'â¹ï¸ åœæ­¢ç§»å‹•';
            statusElement.style.color = '#ff9800';
            currentMoving = false;
            setTimeout(() => {
                if (isConnected && !currentMoving) {
                    statusElement.innerHTML = 'æº–å‚™å°±ç·’ ğŸŸ¢';
                    statusElement.style.color = '#666';
                }
            }, 1000);
        }
        
        // æ ¹æ“šæ»‘æ¡¿åƒæ•¸èª¿æ•´æŒ‡ä»¤
        let adjustedCommand = command;
        if (command === 'L' || command === 'R') {
            // è½‰å‘æŒ‡ä»¤åŠ å…¥éˆæ•åº¦åƒæ•¸
            const response = await fetch(`/move?c=${command}&p=${state}&s=${turnSensitivity}`);
            if (response.ok) {
                isConnected = true;
            } else {
                throw new Error('ç§»å‹•æŒ‡ä»¤åŸ·è¡Œå¤±æ•—');
            }
        } else {
            // å‰é€²å¾Œé€€æŒ‡ä»¤åŠ å…¥é€Ÿåº¦åƒæ•¸
            const response = await fetch(`/move?c=${command}&p=${state}&v=${speedValue}`);
            if (response.ok) {
                isConnected = true;
            } else {
                throw new Error('ç§»å‹•æŒ‡ä»¤åŸ·è¡Œå¤±æ•—');
            }
        }
        
    } catch (error) {
        statusElement.innerHTML = 'âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¨­å‚™';
        statusElement.style.color = '#f44336';
        isConnected = false;
        currentMoving = false;
    }
}

async function sendAct(command) {
    const statusElement = document.getElementById('status');
    
    try {
        statusElement.innerHTML = `åŸ·è¡Œ: ${getCommandName(command)} â³`;
        statusElement.style.color = '#ff9800';
        
        // æ‰‹è‡‚å‹•ä½œåŠ å…¥é€Ÿåº¦åƒæ•¸
        let url = `/act?c=${command}`;
        if (command === 'U' || command === 'D') {
            url += `&a=${armSpeed}`;
        }
        
        const response = await fetch(url);
        
        if (response.ok) {
            statusElement.innerHTML = `âœ… å·²åŸ·è¡Œ: ${getCommandName(command)}`;
            statusElement.style.color = '#4caf50';
            isConnected = true;
        } else {
            throw new Error('å‹•ä½œæŒ‡ä»¤åŸ·è¡Œå¤±æ•—');
        }
        
        // 2ç§’å¾Œå›åˆ°æº–å‚™ç‹€æ…‹
        setTimeout(() => {
            if (isConnected && !currentMoving) {
                statusElement.innerHTML = 'æº–å‚™å°±ç·’ ğŸŸ¢';
                statusElement.style.color = '#666';
            }
        }, 2000);
        
    } catch (error) {
        statusElement.innerHTML = 'âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¨­å‚™';
        statusElement.style.color = '#f44336';
        isConnected = false;
    }
}

function getCommandName(command) {
    const commands = {
        'F': 'å‰é€²',
        'B': 'å¾Œé€€', 
        'L': 'å·¦è½‰',
        'R': 'å³è½‰',
        'S': 'åœæ­¢',
        'U': 'æ‰‹è‡‚ä¸Šå‡',
        'D': 'æ‰‹è‡‚ä¸‹é™',
        'O': 'å¼µé–‹',
        'C': 'å¤¾ç·Š',
        'X': 'ç¿»è½‰',
        'H': 'å›åˆ°åŸé»'
    };
    return commands[command] || command;
}

// æ»‘æ¡¿æ›´æ–°å‡½æ•¸
function updateSpeed(value) {
    speedValue = parseInt(value);
    document.getElementById('speed-value').textContent = value;
    
    // ç™¼é€é€Ÿåº¦æ›´æ–°åˆ°å¾Œç«¯
    fetch(`/config?type=speed&value=${value}`)
        .catch(error => console.log('é€Ÿåº¦è¨­å®šæ›´æ–°:', value));
}

function updateTurnSensitivity(value) {
    turnSensitivity = parseInt(value);
    document.getElementById('turn-value').textContent = value;
    
    // ç™¼é€è½‰å‘éˆæ•åº¦æ›´æ–°åˆ°å¾Œç«¯
    fetch(`/config?type=turn&value=${value}`)
        .catch(error => console.log('è½‰å‘éˆæ•åº¦è¨­å®šæ›´æ–°:', value));
}

function updateArmSpeed(value) {
    armSpeed = parseInt(value);
    document.getElementById('arm-value').textContent = value;
    
    // ç™¼é€æ‰‹è‡‚é€Ÿåº¦æ›´æ–°åˆ°å¾Œç«¯
    fetch(`/config?type=arm&value=${value}`)
        .catch(error => console.log('æ‰‹è‡‚é€Ÿåº¦è¨­å®šæ›´æ–°:', value));
}

// é‡ç½®æ‰€æœ‰åƒæ•¸åˆ°é è¨­å€¼
function resetSettings() {
    document.getElementById('speed-slider').value = 50;
    document.getElementById('turn-slider').value = 50;
    document.getElementById('arm-slider').value = 30;
    
    updateSpeed(50);
    updateTurnSensitivity(50);
    updateArmSpeed(30);
    
    const statusElement = document.getElementById('status');
    statusElement.innerHTML = 'ğŸ”„ åƒæ•¸å·²é‡ç½®';
    statusElement.style.color = '#2196f3';
    
    setTimeout(() => {
        statusElement.innerHTML = 'æº–å‚™å°±ç·’ ğŸŸ¢';
        statusElement.style.color = '#666';
    }, 2000);
}

// éµç›¤æ§åˆ¶æ”¯æ´
let keyPressed = {};

document.addEventListener('keydown', function(event) {
    if (keyPressed[event.key]) return; // é˜²æ­¢é‡è¤‡è§¸ç™¼
    
    const moveKeys = {
        'ArrowUp': 'F',
        'ArrowDown': 'B', 
        'ArrowLeft': 'L',
        'ArrowRight': 'R',
        'w': 'F',
        'W': 'F',
        's': 'B',
        'S': 'B',
        'a': 'L',
        'A': 'L',
        'd': 'R',
        'D': 'R'
    };
    
    const actionKeys = {
        ' ': 'S' // ç©ºç™½éµåœæ­¢
    };
    
    if (moveKeys[event.key]) {
        event.preventDefault();
        keyPressed[event.key] = true;
        send(moveKeys[event.key], 1);
        
        // è¦–è¦ºåé¥‹
        highlightButton(moveKeys[event.key], true);
    } else if (actionKeys[event.key]) {
        event.preventDefault();
        keyPressed[event.key] = true;
        sendAct(actionKeys[event.key]);
        
        // è¦–è¦ºåé¥‹
        highlightButton(actionKeys[event.key], false);
    }
});

document.addEventListener('keyup', function(event) {
    const moveKeys = {
        'ArrowUp': 'F',
        'ArrowDown': 'B', 
        'ArrowLeft': 'L',
        'ArrowRight': 'R',
        'w': 'F',
        'W': 'F',
        's': 'B',
        'S': 'B',
        'a': 'L',
        'A': 'L',
        'd': 'R',
        'D': 'R'
    };
    
    if (moveKeys[event.key] && keyPressed[event.key]) {
        event.preventDefault();
        keyPressed[event.key] = false;
        send(moveKeys[event.key], 0);
        
        // æ¢å¾©è¦–è¦ºæ•ˆæœ
        highlightButton(moveKeys[event.key], false);
    }
});

function highlightButton(command, isPressed) {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        const onmousedown = btn.getAttribute('onmousedown');
        const onclick = btn.getAttribute('onclick');
        
        if ((onmousedown && onmousedown.includes(`'${command}'`)) || 
            (onclick && onclick.includes(`'${command}'`))) {
            if (isPressed) {
                btn.style.transform = 'scale(0.95)';
                btn.style.filter = 'brightness(1.2)';
            } else {
                btn.style.transform = '';
                btn.style.filter = '';
            }
        }
    });
}

// é˜²æ­¢é é¢åˆ·æ–°
window.addEventListener('beforeunload', function(e) {
    if (!isConnected) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // è¼‰å…¥å„²å­˜çš„è¨­å®š
    const savedSpeed = localStorage.getItem('robotSpeed');
    const savedTurn = localStorage.getItem('robotTurn');
    const savedArm = localStorage.getItem('robotArm');
    
    if (savedSpeed) {
        document.getElementById('speed-slider').value = savedSpeed;
        updateSpeed(savedSpeed);
    }
    if (savedTurn) {
        document.getElementById('turn-slider').value = savedTurn;
        updateTurnSensitivity(savedTurn);
    }
    if (savedArm) {
        document.getElementById('arm-slider').value = savedArm;
        updateArmSpeed(savedArm);
    }
});

// å„²å­˜è¨­å®šåˆ°æœ¬åœ°å­˜å„²
function saveSettings() {
    localStorage.setItem('robotSpeed', speedValue);
    localStorage.setItem('robotTurn', turnSensitivity);
    localStorage.setItem('robotArm', armSpeed);
}

// ç›£è½æ»‘æ¡¿è®ŠåŒ–ï¼Œè‡ªå‹•å„²å­˜
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('slider')) {
        setTimeout(saveSettings, 500); // å»¶é²å„²å­˜ï¼Œé¿å…é »ç¹æ“ä½œ
    }
});

console.log('Arduinoé™æ§è»Šæ§åˆ¶å°å·²è¼‰å…¥ ğŸš—');
console.log('éµç›¤æ§åˆ¶: æ–¹å‘éµæˆ–WASD (æŒ‰ä½ç§»å‹•)ï¼Œç©ºç™½éµåœæ­¢');
console.log('ç§»å‹•API: /move?c={command}&p={state}&v={speed}&s={sensitivity}');
console.log('å‹•ä½œAPI: /act?c={command}&a={armSpeed}');
console.log('è¨­å®šAPI: /config?type={type}&value={value}');
</script>
</body>
</html>
